<?xml version="1.0" encoding="utf-8"?>
<s:View xmlns:fx="http://ns.adobe.com/mxml/2009" 
		xmlns:s="library://ns.adobe.com/flex/spark"
		title="登录"
		backgroundColor="#95CDE7"
		xmlns:components="components.*"
		viewActivate="view1_viewActivateHandler(event)">
	<fx:Style>
		@namespace s "library://ns.adobe.com/flex/spark";
		@namespace f "spark.skins.mobile.*";
		
		@media (os-platform: "IOS")
		{
			.loginButton
			{
				chromeColor: #319ED7;
				color: #FFFFFF;
				textShadowColor: #000000;
			}
		}
	</fx:Style>
	
	
	<fx:Script>
		<![CDATA[
			import classes.DataManager;
			
			import com.sina.microblog.MicroBlog;
			import com.sina.microblog.events.MicroBlogEvent;
			
			import events.LoginEvent;
			
			import mx.core.FlexGlobals;
			
			import spark.events.ViewNavigatorEvent;
			
			private var _mb:MicroBlog;
			
			protected function btnLogin_clickHandler(event:MouseEvent):void
			{
				txtError.text = "";
				txtError.includeInLayout = false;
				DataManager.instance.user.login(txtUser.text, txtPwd.text);
				busyIndicator.visible = true;
			}
			
			protected function btnWeiboLogin_clickHandler(event:MouseEvent):void
			{
				_mb.addEventListener(MicroBlogEvent.LOGIN_RESULT, onLoginResult);
				_mb.login(txtUser.text, txtPwd.text);
			}
			
			protected function onLoginResult(e:MicroBlogEvent):void
			{
				trace(e);
				_mb.removeEventListener(MicroBlogEvent.LOGIN_RESULT, onLoginResult);
				btnLogin.text = e.result["access_token"];
				trace(e.result["access_token"] + "::" + e.result["expires_in"] + "::" + e.result["refresh_token"]);  
			}
			
			private function loginHandler(event:LoginEvent):void
			{
				busyIndicator.visible = false;
				if (event.success) {
					FlexGlobals.topLevelApplication.persistenceManager.setProperty("username", txtUser.text);
					FlexGlobals.topLevelApplication.persistenceManager.setProperty("password", txtPwd.text);
					navigator.popView();
				}
				else {
					txtError.text = event.error;
					txtError.includeInLayout = true;
				}
			}
			
			protected function view1_viewActivateHandler(event:ViewNavigatorEvent):void
			{
				var user:String = FlexGlobals.topLevelApplication.persistenceManager.getProperty("username");
				var pass:String = FlexGlobals.topLevelApplication.persistenceManager.getProperty("password");
				if (user && pass)
				{
					txtUser.text = user;
					txtPwd.text = pass;
				}
					
				_mb = new MicroBlog();
				_mb.consumerKey = "1045842202"; //申请的App Key
				_mb.consumerSecret = "8ab688a061c33aa4a76acfb0279109fe"; //申请的App Secrect
				_mb.proxyURI = "http://flashsdk.sinaapp.com/proxy/proxy.php"; //写你自己部署的代理接口地址
			}
			
		]]>
	</fx:Script>
	<s:creationComplete>
		<![CDATA[
		DataManager.instance.user.addEventListener(LoginEvent.name, loginHandler);
		]]>
	</s:creationComplete>
	
	<s:Scroller width="100%" height="100%">
		<s:Group width="100%" height="100%">
			<s:layout>
				<s:MultiDPIVerticalLayout sourceDPI="320"
										  paddingTop="60" paddingBottom="20" paddingLeft="80" paddingRight="80" gap="0"/>
			</s:layout>
			<!-- logo -->
			<s:HGroup width="100%" height="150">
				<s:Spacer width="100%"/>
				<s:BitmapImage source="@Embed(source='assets/banner-login-top.png')" width="320" height="92"/>
				<s:Spacer width="100%"/>
			</s:HGroup>
			
			<!-- input fields -->
			<s:Group width="100%" height="124">
				<s:Rect width="100%" height="100%" radiusX="12">
					<s:fill>
						<s:SolidColor color="#FFFFFF" alpha="1"/>
					</s:fill>
				</s:Rect>
				<s:Label backgroundColor="#95CDE7" width="100%" height="2" y="61"/>
				<components:HintTextInput id="txtUser" hint="用户名" width="100%" y="0"/>
				<components:HintTextInput id="txtPwd" displayAsPassword="true" hint="密码" width="100%" y="63"/>
			</s:Group>
			<s:Spacer height="20"/>
			
			<!-- site user login -->
			<s:Group width="100%" height="68">
				<s:Rect width="100%" height="100%" radiusX="8">
					<s:fill>
						<s:SolidColor color="#05b5ed"/>
					</s:fill>
					<s:stroke>
						<s:SolidColorStroke color="#000000" alpha="0.2" weight="2"/>
					</s:stroke>
				</s:Rect>
				<s:Label id="btnLogin" text="登录"
						 width="100%" height="100%"
						 styleName="captionText"
						 color="#FFFFFF"
						 textAlign="center" verticalAlign="middle"
						 click="btnLogin_clickHandler(event)"
						 />
				<s:BusyIndicator id="busyIndicator" symbolColor="#0C3170" height="40" visible="false" right="20" top="14"/>
			</s:Group>
			<s:Spacer height="20"/>
			<s:Label id="lblRegister" text="还没有账号？马上注册" click="navigateToURL(new URLRequest('http://www.glr.cn/'));"/>
			<s:Spacer height="20"/>
			<s:Label id="txtError" color="#ff0000" includeInLayout="false"/>
			<s:Spacer height="20"/>
			
			<!-- weibo user login -->
			<s:Group width="100%" height="68">
				<s:Rect width="100%" height="100%" radiusX="8">
					<s:fill>
						<s:SolidColor color="#82CB23"/>
					</s:fill>
					<s:stroke>
						<s:SolidColorStroke color="#000000" alpha="0.2" weight="2"/>
					</s:stroke>
				</s:Rect>
				<s:Label text="微博登录"
						 width="100%" height="100%"
						 styleName="captionText"
						 color="#FFFFFF"
						 textAlign="center" verticalAlign="middle"
						 click="btnWeiboLogin_clickHandler(event)"
						 />
			</s:Group>
		</s:Group>
	</s:Scroller>
</s:View>